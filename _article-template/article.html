<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="[CASE_DESCRIPTION] - A Broken Institutions investigation">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'">
    <title>[CASE_TITLE] | Broken Institutions</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/article.css">

    <!-- Theme initialization script (inline to prevent flicker) -->
    <style id="no-transitions">
        *, *::before, *::after {
            transition: none !important;
            animation: none !important;
        }
    </style>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }

            // Remove no-transitions style after everything is loaded and rendered
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const noTransitionsStyle = document.getElementById('no-transitions');
                    if (noTransitionsStyle) {
                        noTransitionsStyle.remove();
                    }
                }, 150);
            });
        })();
    </script>

    <!-- Component System -->
    <script src="../../components/TemplateEngine.js"></script>
    <script src="../../components/ComponentLoader.js"></script>
    <script src="../../components/ArticleRenderer.js"></script>

    <!-- Core JavaScript modules -->
    <script src="../../js/theme-toggle.js"></script>
    <script src="../../js/tabs.js"></script>
    <script src="../../js/app.js"></script>
</head>
<body>
    <div id="article-container">
        <!-- Article content will be dynamically loaded here -->
        <div class="loading-state">
            <p>Loading investigation...</p>
        </div>
    </div>

    <script>
        // Initialize modular article system
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize template engine
                await window.templateEngine.init({
                    basePath: '../../'
                });

                // Create component loader
                const componentLoader = new ComponentLoader(window.templateEngine);

                // Create article renderer
                const articleRenderer = new ArticleRenderer(window.templateEngine, componentLoader);

                // Render the [CASE_ID] article
                await articleRenderer.renderArticle('[CASE_ID]', {
                    container: '#article-container',
                    basePath: '../../'
                });

            } catch (error) {
                console.error('Failed to initialize modular article:', error);

                // Fallback error display
                document.getElementById('article-container').innerHTML = `
                    <div class="error-state">
                        <h1>Investigation Failed to Load</h1>
                        <p>We're experiencing technical difficulties loading this investigation.</p>
                        <p class="error-details">${error.message}</p>
                        <a href="../../index.html" class="back-link">Back to Archive</a>
                    </div>
                `;
            }
        });

        // Handle article ready event
        document.addEventListener('articleReady', function(event) {
            console.log('Article loaded:', event.detail.article.metadata.title);

            // Remove loading state
            const loadingState = document.querySelector('.loading-state');
            if (loadingState) {
                loadingState.remove();
            }
        });
    </script>
</body>
</html>